{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
    <button onclick="openTeamModal()" style="background: #1a1a1a; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">+ New Team</button>
</div>

<div style="background: white; border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: #f9f9f9;">
            <tr>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Team Name</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Members</th>
                <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">Company</th>
            </tr>
        </thead>
        <tbody>
            {% for team in teams %}
            <tr onclick="openTeamModal('{{ team._id }}')" style="border-bottom: 1px solid #eee; cursor: pointer;" onmouseover="this.style.background='#f5f5f5';" onmouseout="this.style.background='white';">
                <td style="padding: 15px;"><strong>{{ team.name }}</strong></td>
                <td style="padding: 15px;">
                    {% if team.members|length > 0 %}
                        {{ team.members[0] }}{% if team.members|length > 1 %}, +{{ team.members|length - 1 }}{% endif %}
                    {% else %}
                        No members
                    {% endif %}
                </td>
                <td style="padding: 15px;">{{ team.company }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="teamModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000;">
    <div style="background: white; width: 500px; padding: 30px; border-radius: 8px; position: relative; box-shadow: 0 5px 25px rgba(0,0,0,0.2);">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="modalTitle" style="margin:0;">Team Details</h2>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button id="editBtn" onclick="enableEditing()" style="background:none; border:none; cursor:pointer; font-size:20px; display:none;">‚úèÔ∏è</button>
                <span onclick="closeModal()" style="cursor: pointer; font-size: 28px;">&times;</span>
            </div>
        </div>

        <form id="teamForm" action="/api/teams/save" method="POST">
            <input type="hidden" id="team_id" name="team_id">
            
            <label class="modal-label">Team Name</label>
            <input type="text" id="t_name" name="name" required class="t-input">

            <label class="modal-label">Company</label>
            <input type="text" id="t_company" name="company" class="t-input">

            <label class="modal-label">Team Members</label>
            <div id="memberContainer"></div>
            <button type="button" id="addMemberBtn" onclick="addMemberField()" style="background: none; border: 1px dashed #ccc; width: 100%; padding: 8px; margin-top: 5px; cursor: pointer; font-size: 12px; display:none;">+ Add Member</button>

            <div style="margin-top: 30px; display: flex; justify-content: space-between;">
                <button type="button" id="deleteBtn" onclick="confirmDelete()" style="background:none; border:1px solid #ff6b6b; color:#ff6b6b; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold; display:none;">üóë Delete</button>
                <button type="submit" id="saveBtn" style="padding: 10px 30px; background: #1a1a1a; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-left: auto; display:none;">Save Team</button>
            </div>
        </form>
    </div>
</div>

<style>
    .modal-label { display:block; font-size:12px; font-weight:bold; margin-bottom:5px; margin-top:10px; }
    .t-input { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; box-sizing: border-box; }
    .t-input:disabled { background: #f9f9f9; color: #666; cursor: not-allowed; border: 1px solid #eee; }
    .member-row { display: flex; gap: 5px; margin-bottom: 5px; }
</style>

<script>
    const container = document.getElementById('memberContainer');
    const form = document.getElementById('teamForm');
    const saveBtn = document.getElementById('saveBtn');
    const editBtn = document.getElementById('editBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const addMemberBtn = document.getElementById('addMemberBtn');

    function addMemberField(value = "", disabled = false) {
        const div = document.createElement('div');
        div.className = 'member-row';
        div.innerHTML = `
            <input type="text" name="members[]" value="${value}" ${disabled ? 'disabled' : ''} placeholder="Member Name" class="t-input" style="flex:1;">
            ${!disabled ? `<button type="button" onclick="this.parentElement.remove()" style="background:#ff6b6b; color:white; border:none; padding:0 10px; border-radius:4px; cursor:pointer;">&times;</button>` : ''}
        `;
        container.appendChild(div);
    }

    async function openTeamModal(id = null) {
        document.getElementById('teamModal').style.display = 'flex';
        container.innerHTML = "";
        form.reset();
        document.getElementById('team_id').value = id || "";

        if (id) {
            // VIEW MODE
            document.getElementById('modalTitle').innerText = "Team Details";
            editBtn.style.display = 'block';
            deleteBtn.style.display = 'block';
            saveBtn.style.display = 'none';
            addMemberBtn.style.display = 'none';
            
            const res = await fetch(`/api/teams/${id}`);
            const data = await res.json();
            document.getElementById('t_name').value = data.name;
            document.getElementById('t_company').value = data.company || "";
            data.members.forEach(m => addMemberField(m, true)); // Add disabled fields

            toggleInputs(true);
        } else {
            // NEW MODE
            document.getElementById('modalTitle').innerText = "New Team";
            editBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
            saveBtn.style.display = 'block';
            addMemberBtn.style.display = 'block';
            
            toggleInputs(false);
            addMemberField(); addMemberField(); // Default two fields
        }
    }

    function toggleInputs(status) {
        document.getElementById('t_name').disabled = status;
        document.getElementById('t_company').disabled = status;
        const memberInputs = container.querySelectorAll('input');
        memberInputs.forEach(i => i.disabled = status);
    }

    function enableEditing() {
        toggleInputs(false);
        saveBtn.style.display = 'block';
        addMemberBtn.style.display = 'block';
        editBtn.style.display = 'none';
        
        // Refresh member fields to add the "X" remove button
        const currentMembers = Array.from(container.querySelectorAll('input')).map(i => i.value);
        container.innerHTML = "";
        currentMembers.forEach(m => addMemberField(m, false));
    }

    function confirmDelete() {
        const id = document.getElementById('team_id').value;
        if (id && confirm("Delete this team and its member list permanently?")) {
            const f = document.createElement('form');
            f.method = 'POST';
            f.action = `/api/teams/delete/${id}`;
            document.body.appendChild(f);
            f.submit();
        }
    }

    function closeModal() { document.getElementById('teamModal').style.display = 'none'; }
    window.onclick = function(e) { if(e.target == document.getElementById('teamModal')) closeModal(); }
</script>
{% endblock %}